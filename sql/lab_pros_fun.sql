
DROP TABLE SPJ CASCADE CONSTRAINTS;
DROP TABLE SP CASCADE CONSTRAINTS;
DROP TABLE J CASCADE CONSTRAINTS;
DROP TABLE P CASCADE CONSTRAINTS;
DROP TABLE S CASCADE CONSTRAINTS;

CREATE TABLE S (
    S_NUM VARCHAR2(10) PRIMARY KEY,
    SNAME VARCHAR2(50),
    STATUS NUMBER,
    CITY VARCHAR2(50)
);

CREATE TABLE P (
    P_NUM VARCHAR2(10) PRIMARY KEY,
    PNAME VARCHAR2(50),
    COLOR VARCHAR2(20),
    WEIGHT NUMBER,
    CITY VARCHAR2(50)
);

CREATE TABLE SP (
    S_NUM VARCHAR2(10),
    P_NUM VARCHAR2(10),
    QTY NUMBER,
    PRIMARY KEY (S_NUM, P_NUM),
    FOREIGN KEY (S_NUM) REFERENCES S(S_NUM),
    FOREIGN KEY (P_NUM) REFERENCES P(P_NUM)
);

CREATE TABLE J (
    J_NUM VARCHAR2(10) PRIMARY KEY,
    JNAME VARCHAR2(50),
    CITY VARCHAR2(50)
);

CREATE TABLE SPJ (
    S_NUM VARCHAR2(10),
    P_NUM VARCHAR2(10),
    J_NUM VARCHAR2(10),
    QTY NUMBER,
    PRIMARY KEY (S_NUM, P_NUM, J_NUM),
    FOREIGN KEY (S_NUM) REFERENCES S(S_NUM),
    FOREIGN KEY (P_NUM) REFERENCES P(P_NUM),
    FOREIGN KEY (J_NUM) REFERENCES J(J_NUM)
);

INSERT INTO S VALUES ('S1', 'Smith', 20, 'London');
INSERT INTO S VALUES ('S2', 'Jones', 10, 'Paris');
INSERT INTO S VALUES ('S3', 'Blake', 30, 'Paris');
INSERT INTO S VALUES ('S4', 'Clark', 20, 'London');
INSERT INTO S VALUES ('S5', 'Adams', 30, 'Athens');

INSERT INTO P VALUES ('P1', 'Nut', 'Red', 12, 'London');
INSERT INTO P VALUES ('P2', 'Bolt', 'Green', 17, 'Paris');
INSERT INTO P VALUES ('P3', 'Screw', 'Blue', 17, 'Rome');
INSERT INTO P VALUES ('P4', 'Screw', 'Red', 14, 'London');
INSERT INTO P VALUES ('P5', 'Cam', 'Blue', 12, 'Paris');
INSERT INTO P VALUES ('P6', 'Cog', 'Red', 19, 'London');

INSERT INTO SP VALUES ('S1', 'P1', 300);
INSERT INTO SP VALUES ('S1', 'P2', 200);
INSERT INTO SP VALUES ('S1', 'P3', 400);
INSERT INTO SP VALUES ('S1', 'P4', 200);
INSERT INTO SP VALUES ('S1', 'P5', 100);
INSERT INTO SP VALUES ('S1', 'P6', 100);
INSERT INTO SP VALUES ('S2', 'P1', 300);
INSERT INTO SP VALUES ('S2', 'P2', 400);
INSERT INTO SP VALUES ('S3', 'P2', 200);
INSERT INTO SP VALUES ('S4', 'P2', 200);
INSERT INTO SP VALUES ('S4', 'P4', 300);
INSERT INTO SP VALUES ('S4', 'P5', 400);

INSERT INTO J VALUES ('J1', 'Sorter', 'Paris');
INSERT INTO J VALUES ('J2', 'Display', 'Rome');
INSERT INTO J VALUES ('J3', 'OCR', 'Athens');
INSERT INTO J VALUES ('J4', 'Console', 'Athens');
INSERT INTO J VALUES ('J5', 'RAID', 'London');
INSERT INTO J VALUES ('J6', 'EDS', 'Oslo');
INSERT INTO J VALUES ('J7', 'Tape', 'London');

INSERT INTO SPJ VALUES ('S1', 'P1', 'J1', 200);
INSERT INTO SPJ VALUES ('S1', 'P1', 'J4', 700);
INSERT INTO SPJ VALUES ('S2', 'P3', 'J1', 400);
INSERT INTO SPJ VALUES ('S2', 'P3', 'J2', 200);
INSERT INTO SPJ VALUES ('S2', 'P3', 'J3', 200);
INSERT INTO SPJ VALUES ('S2', 'P3', 'J4', 500);
INSERT INTO SPJ VALUES ('S2', 'P3', 'J5', 600);
INSERT INTO SPJ VALUES ('S2', 'P3', 'J6', 400);
INSERT INTO SPJ VALUES ('S2', 'P3', 'J7', 800);
INSERT INTO SPJ VALUES ('S2', 'P5', 'J2', 100);
INSERT INTO SPJ VALUES ('S3', 'P3', 'J1', 200);
INSERT INTO SPJ VALUES ('S3', 'P4', 'J2', 500);
INSERT INTO SPJ VALUES ('S4', 'P6', 'J3', 300);
INSERT INTO SPJ VALUES ('S4', 'P6', 'J7', 300);
INSERT INTO SPJ VALUES ('S5', 'P2', 'J2', 200);
INSERT INTO SPJ VALUES ('S5', 'P2', 'J4', 100);
INSERT INTO SPJ VALUES ('S5', 'P5', 'J5', 500);
INSERT INTO SPJ VALUES ('S5', 'P5', 'J7', 100);
INSERT INTO SPJ VALUES ('S5', 'P6', 'J2', 200);
INSERT INTO SPJ VALUES ('S5', 'P1', 'J4', 100);
INSERT INTO SPJ VALUES ('S5', 'P3', 'J4', 200);
INSERT INTO SPJ VALUES ('S5', 'P4', 'J4', 800);
INSERT INTO SPJ VALUES ('S5', 'P5', 'J4', 400);
INSERT INTO SPJ VALUES ('S5', 'P6', 'J4', 500);

COMMIT;

CREATE OR REPLACE PROCEDURE SP_PARTES_NO_PARIS_PESO(
    p_cursor OUT SYS_REFCURSOR
) AS
BEGIN
    OPEN p_cursor FOR
    SELECT COLOR, CITY
    FROM P
    WHERE CITY != 'Paris' AND WEIGHT > 10;
END;
/
--2
CREATE OR REPLACE PROCEDURE SP_PARTES_PESO_GRAMOS(
    p_cursor OUT SYS_REFCURSOR
) AS
BEGIN
    OPEN p_cursor FOR
    SELECT P_NUM, WEIGHT * 453.592 AS PESO_GRAMOS
    FROM P;
END;
/
--3
CREATE OR REPLACE PROCEDURE SP_DETALLE_PROVEEDORES(
    p_cursor OUT SYS_REFCURSOR
) AS
BEGIN
    OPEN p_cursor FOR
    SELECT S_NUM, SNAME, STATUS, CITY
    FROM S;
END;
/
--4
CREATE OR REPLACE PROCEDURE SP_PROV_PARTES_COLOCALIZADOS(
    p_cursor OUT SYS_REFCURSOR
) AS
BEGIN
    OPEN p_cursor FOR
    SELECT S.S_NUM, S.SNAME, P.P_NUM, P.PNAME, S.CITY
    FROM S, P
    WHERE S.CITY = P.CITY;
END;
/
--5
CREATE OR REPLACE PROCEDURE SP_PARES_CIUDADES_ABASTECE(
    p_cursor OUT SYS_REFCURSOR
) AS
BEGIN
    OPEN p_cursor FOR
    SELECT DISTINCT S.CITY AS CIUDAD_PROVEEDOR, P.CITY AS CIUDAD_PARTE
    FROM S, SP, P
    WHERE S.S_NUM = SP.S_NUM
    AND SP.P_NUM = P.P_NUM;
END;
/
--6
CREATE OR REPLACE PROCEDURE SP_PARES_PROV_COLOCALIZADOS(
    p_cursor OUT SYS_REFCURSOR
) AS
BEGIN
    OPEN p_cursor FOR
    SELECT S1.S_NUM AS PROVEEDOR1, S2.S_NUM AS PROVEEDOR2, S1.CITY
    FROM S S1, S S2
    WHERE S1.CITY = S2.CITY
    AND S1.S_NUM < S2.S_NUM;
END;
/
--7
CREATE OR REPLACE FUNCTION FN_TOTAL_PROVEEDORES
RETURN NUMBER
AS
    v_total NUMBER;
BEGIN
    SELECT COUNT(*) INTO v_total FROM S;
    RETURN v_total;
END;
/
SELECT FN_TOTAL_PROVEEDORES() AS TOTAL_PROVEEDORES FROM DUAL;
--8
CREATE OR REPLACE PROCEDURE SP_MIN_MAX_PARTE_P2(
    p_min OUT NUMBER,
    p_max OUT NUMBER
) AS
BEGIN
    SELECT MIN(QTY), MAX(QTY)
    INTO p_min, p_max
    FROM SP
    WHERE P_NUM = 'P2';
END;
/
--9
CREATE OR REPLACE PROCEDURE SP_PARTES_TOTAL_DESPACHADO(
    p_cursor OUT SYS_REFCURSOR
) AS
BEGIN
    OPEN p_cursor FOR
    SELECT P_NUM, SUM(QTY) AS TOTAL_DESPACHADO
    FROM SP
    GROUP BY P_NUM;
END;
/
--10
CREATE OR REPLACE PROCEDURE SP_PARTES_VARIOS_PROVEEDORES(
    p_cursor OUT SYS_REFCURSOR
) AS
BEGIN
    OPEN p_cursor FOR
    SELECT P_NUM
    FROM SP
    GROUP BY P_NUM
    HAVING COUNT(DISTINCT S_NUM) > 1;
END;
/
--11
CREATE OR REPLACE PROCEDURE SP_PROVEEDORES_PARTE_P2(
    p_cursor OUT SYS_REFCURSOR
) AS
BEGIN
    OPEN p_cursor FOR
    SELECT DISTINCT S.SNAME
    FROM S, SP
    WHERE S.S_NUM = SP.S_NUM
    AND SP.P_NUM = 'P2';
END;
/
--12
CREATE OR REPLACE PROCEDURE SP_PROV_ABASTECEN_PARTES(
    p_cursor OUT SYS_REFCURSOR
) AS
BEGIN
    OPEN p_cursor FOR
    SELECT DISTINCT S.SNAME
    FROM S, SP
    WHERE S.S_NUM = SP.S_NUM;
END;
/
--13
CREATE OR REPLACE PROCEDURE SP_PROV_STATUS_MENOR_MAX(
    p_cursor OUT SYS_REFCURSOR
) AS
BEGIN
    OPEN p_cursor FOR
    SELECT S_NUM
    FROM S
    WHERE STATUS < (SELECT MAX(STATUS) FROM S);
END;
/
--14
CREATE OR REPLACE PROCEDURE SP_PROV_P2_EXISTS(
    p_cursor OUT SYS_REFCURSOR
) AS
BEGIN
    OPEN p_cursor FOR
    SELECT SNAME
    FROM S
    WHERE EXISTS (
        SELECT 1
        FROM SP
        WHERE SP.S_NUM = S.S_NUM
        AND SP.P_NUM = 'P2'
    );
END;
/
--15
CREATE OR REPLACE PROCEDURE SP_PROV_NO_ABASTECEN_P2(
    p_cursor OUT SYS_REFCURSOR
) AS
BEGIN
    OPEN p_cursor FOR
    SELECT SNAME
    FROM S
    WHERE NOT EXISTS (
        SELECT 1
        FROM SP
        WHERE SP.S_NUM = S.S_NUM
        AND SP.P_NUM = 'P2'
    );
END;
/
--16
CREATE OR REPLACE PROCEDURE SP_PROV_TODAS_PARTES(
    p_cursor OUT SYS_REFCURSOR
) AS
BEGIN
    OPEN p_cursor FOR
    SELECT S.SNAME
    FROM S
    WHERE NOT EXISTS (
        SELECT P.P_NUM
        FROM P
        WHERE NOT EXISTS (
            SELECT SP.P_NUM
            FROM SP
            WHERE SP.S_NUM = S.S_NUM
            AND SP.P_NUM = P.P_NUM
        )
    );
END;
/
--17
CREATE OR REPLACE PROCEDURE SP_PARTES_PESO_O_S2(
    p_cursor OUT SYS_REFCURSOR
) AS
BEGIN
    OPEN p_cursor FOR
    SELECT DISTINCT P.P_NUM
    FROM P
    LEFT JOIN SP ON P.P_NUM = SP.P_NUM
    WHERE P.WEIGHT > 16 OR SP.S_NUM = 'S2';
END;
/
